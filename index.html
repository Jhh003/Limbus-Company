<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今天蛋筒什么</title>
    <style>
        /* 保持原有样式不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        header {
            margin-bottom: 40px;
            padding: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #d4af37, #f8f8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #aaa;
        }

        .selector-container {
            background: rgba(10, 10, 10, 0.7);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .selector-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .scroll-container {
            overflow: hidden;
            position: relative;
            margin: 20px 0;
            border: 2px solid #d4af37;
            border-radius: 10px;
            background: rgba(20, 20, 30, 0.8);
        }

        .scroll-list {
            position: absolute;
            top: 0;
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .scroll-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }

        .scroll-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar-placeholder {
            border-radius: 50%;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* 选中项高亮效果 */
        .scroll-item.selected {
            background: rgba(212, 175, 55, 0.5);
            color: #ffffff;
            box-shadow: inset 0 0 20px rgba(212, 175, 55, 0.8);
            transform: scale(1.05);
            z-index: 5;
        }

        .selector-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            background: linear-gradient(to bottom, #c41e3a, #8b0000);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            background: linear-gradient(to bottom, #d41e3a, #9b0000);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .control-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            background: rgba(10, 10, 10, 0.7);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 25px;
            margin: 30px auto;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .result-title {
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .result-content {
            font-size: 1.2rem;
            line-height: 1.8;
        }

        .highlight {
            color: #d4af37;
            font-weight: bold;
        }

        .instructions {
            background: rgba(30, 30, 30, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
        }

        .instructions h3 {
            color: #d4af37;
            margin-bottom: 15px;
            text-align: center;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* 新增筛选样式 */
        .filter-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .sinner-checkbox-label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .sinner-checkbox-label:hover {
            background: rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }

        .sinner-checkbox-label input {
            margin-right: 8px;
        }

        .filter-avatar {
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }

        .filter-avatar-placeholder {
            border-radius: 50%;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            margin-right: 8px;
        }

        /* 新增设置页面样式 */
        .settings-page {
            display: none;
            background: rgba(10, 10, 10, 0.7);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .settings-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section-title {
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 20px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .personality-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .personality-setting-card {
            background: rgba(30, 30, 40, 0.8);
            border: 1px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
        }

        .personality-setting-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .personality-avatar {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .personality-name {
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 10px;
        }

        .personality-toggle {
            display: flex;
            align-items: center;
        }

        .personality-toggle input {
            margin-right: 8px;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            font-size: 1rem;
            background: linear-gradient(to bottom, #4a4a8a, #2a2a5a);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: linear-gradient(to bottom, #5a5a9a, #3a3a6a);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(to bottom, #c41e3a, #8b0000);
        }

        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 15px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .page-btn.active {
            background: #d4af37;
            color: #000;
        }

        .page-btn:disabled {
            background: #333;
            cursor: not-allowed;
        }

        .personality-page {
            display: none;
        }

        .personality-page.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .selector-title {
                font-size: 1.5rem;
            }
            
            .scroll-item {
                font-size: 1rem;
            }
            
            .personality-settings-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
    <style>
        /* 第七赛季动画效果 */
        @import url("https://fonts.googleapis.com/css?family=Lora:400,400i,700");
        
        .season-text {
            color: #ff4500; /* 猩红偏黄 */
            font-weight: bold;
            font-family: Lora, serif;
            display: inline-block;
            margin: 0 10px;
        }
        
        .glowIn {
            display: inline-block;
        }
        
        .glowIn span {
            animation: glow-in 0.8s both infinite alternate;
            display: inline-block;
            color: #ff4500;
            font-weight: bold;
            font-family: Lora, serif;
        }
        
        @keyframes glow-in {
            from {
                opacity: 0;
            }
            65% {
                opacity: 1;
                text-shadow: 0 0 25px #ff4500;
            }
            75% {
                opacity: 1;
            }
            to {
                opacity: 0.7;
            }
        }
    </style>
    <script>
        // 倒计时功能：使用新的时间API
        async function fetchCurrentTime() {
            try {
                const response = await fetch('https://cn.apihz.cn/api/time/getapi.php?id=10010737&key=949afa1fb7d14d5ea210b69a761595a5&type=20');
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                const data = await response.json();
                if (data.code === 200) {
                    // 返回时间戳（秒），转换为毫秒
                    return data.sjc * 1000;
                } else {
                    throw new Error('API返回错误');
                }
            } catch (error) {
                console.error('获取时间失败:', error);
                // 失败时使用本地时间
                return Date.now();
            }
        }

        function calculateTimeRemaining(currentTime) {
            // 目标日期：2025年12月31日 11:00:00 (UTC)
            const endDate = new Date('2025-12-31T11:00:00Z');
            const endTime = endDate.getTime();
            const diffTime = endTime - currentTime;

            // 计算剩余天数、小时数、分钟数和秒数
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffTime % (1000 * 60 * 60)) / (1000 * 60));
            const diffSeconds = Math.floor((diffTime % (1000 * 60)) / 1000);

            return { diffDays, diffHours, diffMinutes, diffSeconds };
        }

        async function updateCountdown() {
            const currentTime = await fetchCurrentTime();
            const { diffDays, diffHours, diffMinutes, diffSeconds } = calculateTimeRemaining(currentTime);
            const countdownElement = document.getElementById('countdown');

            if (diffDays >= 0) {
                countdownElement.innerHTML = 
                    `距离边狱巴士<span class="glowIn"><span>第</span><span>七</span><span>赛</span><span>季</span></span>还有: <span style="color: gold; font-weight: bold;">${diffDays}</span>天<span style="color: gold; font-weight: bold;">${diffHours}</span>小时<span style="color: gold; font-weight: bold;">${diffMinutes}</span>分<span style="color: gold; font-weight: bold;">${diffSeconds}</span>秒`;
            } else {
                countdownElement.innerHTML = '边狱巴士第七赛季已开始';
            }
        }

        // 页面加载后初始化倒计时
        document.addEventListener('DOMContentLoaded', () => {
            updateCountdown();
            // 每秒更新一次倒计时
            setInterval(updateCountdown, 1000);
        });
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>边狱巴士 - 今天蛋筒什么？</h1>
            <p class="description">版本：1.1.1</p>
            <div id="countdown" style="margin-top: 20px; font-size: 1.5rem; color: #d4af37;"></div>
        </header>

        <!-- 导航按钮 -->
        <div class="navigation-buttons">
            <button id="main-page-btn" class="nav-btn active">主选择器</button>
            <button id="settings-page-btn" class="nav-btn">筛选设置</button>
        </div>

        <!-- 主选择器页面 -->
        <div id="main-selector-page">
            <div class="selector-container">
                <!-- 一级选择器：罪人选择 -->
                <div class="selector-section">
                    <h2 class="selector-title">
                        <i class="fas fa-user-tag"></i> 一级选择 - 12名罪人
                    </h2>
                    <div class="scroll-container" id="sinner-scroll-container">
                        <div id="sinner-scroll" class="scroll-list"></div>
                    </div>
                    <div class="selector-controls">
                        <button id="sinner-start-btn" class="control-btn">
                            <i class="fas fa-play"></i> 开始滚动
                        </button>
                        <button id="sinner-stop-btn" class="control-btn" disabled>
                            <i class="fas fa-stop"></i> 停止选择
                        </button>
                    </div>
                </div>

                <!-- 二级选择器：人格选择 -->
                <div class="selector-section" style="margin-top: 40px;">
                    <h2 class="selector-title">
                        <i class="fas fa-mask"></i> 二级选择 - 罪人人格
                    </h2>
                    <div class="scroll-container" id="persona-scroll-container">
                        <div id="persona-scroll" class="scroll-list"></div>
                    </div>
                    <div class="selector-controls">
                        <button id="persona-start-btn" class="control-btn" disabled>
                            <i class="fas fa-play"></i> 开始滚动
                        </button>
                        <button id="persona-stop-btn" class="control-btn" disabled>
                            <i class="fas fa-stop"></i> 停止选择
                        </button>
                    </div>
                </div>
            </div>

            <!-- 结果显示区域 -->
            <div class="result-section">
                <h3 class="result-title">
                    <i class="fas fa-trophy"></i> 选择结果
                </h3>
                <div class="result-content">
                    <p><span class="highlight">当前选中罪人：</span><span id="selected-sinner">未选择</span></p>
                    <p><span class="highlight">当前选中人格：</span><span id="selected-persona">未选择</span></p>
                </div>
            </div>
        </div>

        <!-- 筛选设置页面 -->
        <div id="settings-page" class="settings-page">
            <h2 class="settings-title">
                <i class="fas fa-cog"></i> 筛选设置
            </h2>
            
            <!-- 罪人筛选设置 -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-user-friends"></i> 罪人筛选设置
                </h3>
                <div class="filter-controls">
                    <button id="select-all-btn" class="control-btn" style="margin: 10px 5px; padding: 8px 15px; font-size: 0.9rem;">
                        全选
                    </button>
                    <button id="deselect-all-btn" class="control-btn" style="margin: 10px 5px; padding: 8px 15px; font-size: 0.9rem;">
                        全不选
                    </button>
                    <button id="invert-selection-btn" class="control-btn" style="margin: 10px 5px; padding: 8px 15px; font-size: 0.9rem;">
                        反选
                    </button>
                </div>
                <div id="sinner-filter" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 20px;"></div>
            </div>
            
            <!-- 人格筛选设置 -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-id-card"></i> 人格整体筛选设置
                </h3>
                <div id="personality-settings-container">
                    <!-- 人格设置将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="instructions">
            <h3>使用说明</h3>
            <ul>
                <li>数据、图片均来自Limbus Company 中文维基</li>
                <li>在筛选设置中选择要参与随机的罪人</li>
                <li>点击"开始滚动"按钮启动滚动选择</li>
                <li>点击"停止选择"按钮确定当前选项</li>
                <li>一级选择完成后，二级选择器将自动解锁</li>
                <li>每次选择均为随机，确保公平性</li>
                <li>支持手机、平板、电脑等多种设备访问</li>
                <li>欢迎反馈、提建议、报告Bug</li>
                <li>084 QQ交流群：313198040</li>
            </ul>
        </div>
    </div>

    <script>
        // 罪人及人格数据 (预留头像字段)
        const sinnerData = [
            {
                 id: 1,
                name: "李箱 (Yi Sang)",
                avatar: "images/Yi_Sang/Yi_Sang-LCB.jpg",
                color: '#9370DB',
                personalities: [
                    { name: "W公司3级清扫人员", avatar: "images/Yi_Sang/Yi_Sang-W3.webp" },
                    { name: "Seven协会南部6科", avatar: "images/Yi_Sang/Yi_Sang-Seven.jpg" },
                    { name: "N公司E.G.O:凶弹", avatar: "images/Yi_Sang/Yi_Sang-N.webp" },
                    { name: "LCE E.G.O:提灯", avatar: "images/Yi_Sang/Yi_Sang-LCE.webp" },
                    { name: "LCB罪人", avatar: "images/Yi_Sang/Yi_Sang-LCB.jpg" },
                    { name: "Dieci协会南部4科", avatar: "images/Yi_Sang/Yi_Sang-Dieci.webp" },
                    { name: "绽放E.G.O:山茶花", avatar: "images/Yi_Sang/Yi_Sang-hua_xiang.webp" },
                    { name: "裴廓德号大副", avatar: "images/Yi_Sang/Yi_Sang-da_fu.webp" },
                    { name: "脑叶公司E.G.O:庄严哀悼", avatar: "images/Yi_Sang/Yi_Sang-ai_dao.webp" },
                    { name: "六协会南部3科", avatar: "images/Yi_Sang/Yi_Sang-6.webp" },
                    { name: "臼齿事务所收尾人", avatar: "images/Yi_Sang/Yi_Sang-jiu_chi.webp" },
                    { name: "剑契组杀手", avatar: "images/Yi_Sang/Yi_Sang-jian_qi.webp" },
                    { name: "环指点彩派学徒", avatar: "images/Yi_Sang/Yi_Sang-huan_zhi.webp" },
                    { name: "黑兽-午魁首", avatar: "images/Yi_Sang/Yi_Sang-ma.webp" }
                ]
            },
            {
                id: 2,
                name: "浮士德 (Faust)",
                avatar: "images/Faust/Faust-LCB.jpg",
                color: '#4169E1',
                personalities: [
                    { name: "し协会东部3科", avatar: "images/Faust/Faust-し.webp" },
                    { name: "Zwei协会南部4科", avatar: "images/Faust/Faust-Zwei.webp" },
                    { name: "W公司2级清扫人员", avatar: "images/Faust/Faust-W.webp" },
                    { name: "Seven协会南部4科", avatar: "images/Faust/Faust-Seven.webp" },
                    { name: "LCE_E.G.O:红艳煞", avatar: "images/Faust/Faust-LCE.webp" },
                    { name: "LCB罪人", avatar: "images/Faust/Faust-LCB.jpg" },
                    { name: "执柄者", avatar: "images/Faust/Faust-N.webp" },
                    { name: "脑叶公司E.G.O:悔恨", avatar: "images/Faust/Faust-L2.webp" },
                    { name: "脑叶公司幸存者", avatar: "images/Faust/Faust-L.webp" },
                    { name: "剑契组杀手", avatar: "images/Faust/Faust-jian_qi.webp" },
                    { name: "呼啸山庄管家", avatar: "images/Faust/Faust-guan_jia.webp" },
                    { name: "黑兽-卯魁首", avatar: "images/Faust/Faust-tu.webp" },
                    { name: "多裂纹事务所代表", avatar: "images/Faust/Faust-duo_lie.webp" }
                ]
            },
            {
                id: 3,
                name: "堂吉诃德 (Don Quixote)",
                avatar: "images/Don_Quixote/Don_Quixote-LCB.jpg",
                color: '#FF6347',
                personalities: [
                    { name: "し协会南部5科科长", avatar: "  images/Don_Quixote/Don_Quixote-し.webp" },
                    { name: "W公司3级清扫人员", avatar: "images/Don_Quixote/Don_Quixote-W.webp" },
                    { name: "T公司3级征收人员", avatar: "images/Don_Quixote/Don_Quixote-T.webp" },
                    { name: "N公司中锤", avatar: "images/Don_Quixote/Don_Quixote-N.webp" },
                    { name: "LCB罪人", avatar: "images/Don_Quixote/Don_Quixote-LCB.jpg" },
                    { name: "Cinq协会南部5科科长", avatar: "images/Don_Quixote/Don_Quixote-Cinq.webp " },
                    { name: "Cinq协会东部3科", avatar: "images/Don_Quixote/Don_Quixote-Cinq2.webp" },
                    { name: "中指幼妹", avatar: "images/Don_Quixote/Don_Quixote-zhong_zhi.webp" },
                    { name: "脑叶公司E.G.O:以爱与憎之名", avatar: "images/Don_Quixote/Don_Quixote-zeng_wu.webp" },
                    { name: "脑叶公司E.G.O:提灯", avatar: "images/Don_Quixote/Don_Quixote-L.webp" },
                    { name: "拉·曼却领总督", avatar: "images/Don_Quixote/Don_Quixote-xue_tang.webp" },
                    { name: "剑契组杀手", avatar: " images/Don_Quixote/Don_Quixote-jian_qi.webp" },
                    { name: "黑兽-未", avatar: " images/Don_Quixote/Don_Quixote-yang.webp" }
                ]
            },
            {
                id: 4,
                name: "良秀 (Ryoshu)",
                avatar: "images/Ryoshu/Ryoshu-LCB.jpg",
                color: '#DC143C',
                personalities: [
                    { name: "W公司3级清扫人员", avatar: "images/Ryoshu/Ryoshu-W.webp" },
                    { name: "Seven协会南部6科", avatar: "images/Ryoshu/Ryoshu-Seven.webp" },
                    { name: "N公司E.G.O:轻蔑，敬畏", avatar: "images/Ryoshu/Ryoshu-N.webp" },
                    { name: "LCCB系长", avatar: "images/Ryoshu/Ryoshu-LCCB.webp" },
                    { name: "LCB罪人", avatar: "images/Ryoshu/Ryoshu-LCB.jpg" },
                    { name: "脑叶公司E.G.O:赤瞳·忏悔", avatar: "images/Ryoshu/Ryoshu-L.webp" },
                    { name: "六协会南部4科", avatar: "images/Ryoshu/Ryoshu-6.webp" },
                    { name: "良·派厨师长", avatar: "images/Ryoshu/Ryoshu-chu_shi.webp" },
                    { name: "鸿园的流浪武者", avatar: "images/Ryoshu/Ryoshu-dai_yv.webp" },
                    { name: "黑云会若众", avatar: "images/Ryoshu/Ryoshu-hei_yun.webp" },
                    { name: "黑兽-卯", avatar: "images/Ryoshu/Ryoshu-tu.webp" },
                    { name: "埃德加家族首席管家", avatar: "images/Ryoshu/Ryoshu-ai_dejia.webp" },
                    { name: "20区圣愚", avatar: "images/Ryoshu/Ryoshu-sheng_yv.webp" }
                ]
            },
            {
                id: 5,
                name: "默尔索 (Meursault)",
                avatar: "images/Meursault/Meursault-LCB.jpg",
                color: '#708090',
                personalities: [
                    { name: "W公司2级清扫人员", avatar: "images/Meursault/Meursault-W.webp" },
                    { name: "R公司第四集团军犀牛队", avatar: "images/Meursault/Meursault-R.webp" },
                    { name: "N公司大锤", avatar: "images/Meursault/Meursault-N.webp" },
                    { name: "LCB罪人", avatar: "images/Meursault/Meursault-LCB.jpg" },
                    { name: "Dieci协会南部4科科长", avatar: "images/Meursault/Meursault-Dieci.webp" },
                    { name: "Cinq协会西部3科", avatar: "images/Meursault/Meursault-Cinq.webp" },
                    { name: "中指幼弟", avatar: "images/Meursault/Meursault-zhong_zhi.webp" },
                    { name: "死兔帮老大", avatar: "images/Meursault/Meursault-si_tu.webp" },
                    { name: "拇指东部指挥官IIII", avatar: "images/Meursault/Meursault-lei_heng.webp" },
                    { name: "玫瑰扳手工坊收尾人", avatar: "images/Meursault/Meursault-mei_gui.webp" },
                    { name: "六协会南部6科", avatar: "images/Meursault/Meursault-6.webp" },
                    { name: "拉·曼却领王子", avatar: "images/Meursault/Meursault-la_manque.webp" },
                    { name: "剑契组头领", avatar: "images/Meursault/Meursault-jian_qi.webp" }
                ]
            },
            {
                id: 6,
                name: "鸿璐 (Hong Lu)",
                avatar: "images/Hong_Lu/Hong_Lu-LCB.jpg",
                color: '#228B22',
                personalities: [
                    { name: "W公司2级清扫人员", avatar: "images/Hong_Lu/Hong_Lu-W.webp" },
                    { name: "R公司第四集团军驯鹿队", avatar: "images/Hong_Lu/Hong_Lu-R.webp" },
                    { name: "LCB罪人", avatar: "images/Hong_Lu/Hong_Lu-LCB.jpg" },
                    { name: "K公司3级摘除人员", avatar: "images/Hong_Lu/Hong_Lu-K.webp" },
                    { name: "Dieci协会南部4科", avatar: "images/Hong_Lu/Hong_Lu-Dieci.webp" },
                    { name: "六协会南部5科", avatar: "images/Hong_Lu/Hong_Lu-6.webp" },
                    { name: "猎牙事务所收尾人", avatar: "images/Hong_Lu/Hong_Lu-lie_ya.webp" },
                    { name: "句点事务所代表", avatar: "images/Hong_Lu/Hong_Lu-ju_dian.webp" },
                    { name: "鸿园的君主", avatar: "images/Hong_Lu/Hong_Lu-jun_zhu.webp" },
                    { name: "黑云会若众", avatar: "images/Hong_Lu/Hong_Lu-hei_yun.webp" },
                    { name: "豆豆帮帮主", avatar: "images/Hong_Lu/Hong_Lu-dou_dou.webp" },
                    { name: "吊钩事务所收尾人", avatar: "images/Hong_Lu/Hong_Lu-diao_gou.webp" },
                    { name: "20区圣愚", avatar: "images/Hong_Lu/Hong_Lu-sheng_yv.webp" }
                ]
            },
            {
                id: 7,
                name: "希斯克利夫 (Heathcliff)",
                avatar: "images/Heathcliff/Heathcliff-LCB.jpg",
                color: '#FF4500',
                personalities: [
                    { name: "し协会南部5科", avatar: " images/Heathcliff/Heathcliff-し.webp" },
                    { name: "W公司4级清扫人员-CCA", avatar: "images/Heathcliff/Heathcliff-W.webp" },
                    { name: "Seven协会南部4科", avatar: "images/Heathcliff/Heathcliff-Seven.webp" },
                    { name: "R公司第四集团军兔子队", avatar: "images/Heathcliff/Heathcliff-R.webp" },
                    { name: "Öufi协会南部3科", avatar: "images/Heathcliff/Heathcliff-Öufi.webp" },
                    { name: "N公司小锤", avatar: "images/Heathcliff/Heathcliff-N.webp" },
                    { name: "LCB罪人", avatar: "images/Heathcliff/Heathcliff-LCB.jpg" },
                    { name: "裴廓德号鱼叉手", avatar: "images/Heathcliff/Heathcliff-pai_dehao.webp" },
                    { name: "脑叶公司E.G.O:狐雨", avatar: "images/Heathcliff/Heathcliff-san.webp" },
                    { name: "狂猎", avatar: "images/Heathcliff/Heathcliff-kang_lie.webp" },
                    { name: "句点事务所收尾人", avatar: "images/Heathcliff/Heathcliff-ju_dian.webp" },
                    { name: "黑云会若众", avatar: "images/Heathcliff/Heathcliff-hei_yun.webp" },
                    { name: "黑兽-酉魁首", avatar: "images/Heathcliff/Heathcliff-ji.webp" },
                    { name: "多裂纹事务所收尾人", avatar: "images/Heathcliff/Heathcliff-duo_liewen.webp" }
                ]
            },
            {
                id: 8,
                name: "以实玛利 (Ishmael)",
                avatar: "images/Ishmael/Ishmael-LCB.jpg",
                color: '#191970',
                personalities: [
                    { name: "し协会南部5科", avatar: " images/Ishmael/Ishmael-し.webp" },
                    { name: "Zwei协会西部3科", avatar: "images/Ishmael/Ishmael-Zwei.webp" },
                    { name: "R公司第四集团军驯鹿队", avatar: "images/Ishmael/Ishmael-R.webp" },
                    { name: "LCCB系长", avatar: "images/Ishmael/Ishmael-LCCB.webp" },
                    { name: "LCB罪人", avatar: "images/Ishmael/Ishmael-LCB.jpg" },
                    { name: "裴廓德号船长", avatar: "images/Ishmael/Ishmael-fei_dehao.webp" },
                    { name: "脑叶公司E.G.O:荡漾", avatar: "images/Ishmael/Ishmael-dang_yang.webp" },
                    { name: "六协会南部4科", avatar: "images/Ishmael/Ishmael-6.webp" },
                    { name: "臼齿修船厂收尾人", avatar: "images/Ishmael/Ishmael-jiu_chi.webp" },
                    { name: "家主候选人", avatar: "images/Ishmael/Ishmael-jia_zhu.webp" },
                    { name: "黑云会副会长", avatar: "images/Ishmael/Ishmael-hei_yun.webp" },
                    { name: "定事务所代表", avatar: "images/Ishmael/Ishmael-ding.webp" },
                    { name: "埃德加家族管家", avatar: "images/Ishmael/Ishmael-ai_dejia.webp" }
                ]
            },
            {
                id: 9,
                name: "罗佳 (Rodion)",
                avatar: "images/Rodion/Rodion-LCB.jpg",
                color: '#FF1493',
                personalities: [
                    { name: "Девять协会北部3科", avatar: " images/Rodion/Rodion-Девять.webp" },
                    { name: "Zwei协会南部5科", avatar: "images/Rodion/Rodion-Zwei.webp" },
                    { name: "T公司2级征收人员", avatar: "images/Rodion/Rodion-T.webp" },
                    { name: "N公司中锤", avatar: "images/Rodion/Rodion-N.webp" },
                    { name: "LCCB系长", avatar: "images/Rodion/Rodion-LCCB.webp" },
                    { name: "LCB罪人", avatar: "images/Rodion/Rodion-LCB.jpg" },
                    { name: "Dieci协会南部4科", avatar: "images/Rodion/Rodion-Dieci.webp" },
                    { name: "脑叶公司E.G.O:泪锋之剑", avatar: "images/Rodion/Rodion-lai_feng.webp" },
                    { name: "玫瑰扳手工坊代表", avatar: "images/Rodion/Rodion-mei_gui.webp" },
                    { name: "六协会南部4科科长", avatar: "images/Rodion/Rodion-6.webp" },
                    { name: "拉·曼却领公主", avatar: "images/Rodion/Rodion-la_manque.webp" },
                    { name: "黑云会若众", avatar: "images/Rodion/Rodion-hei_yun.webp" },
                    { name: "黑兽-巳", avatar: "images/Rodion/Rodion-she.webp" }
                ]
            },
            {
                id: 10,
                name: "辛克莱 (Sinclair)",
                avatar: "images/Sinclair/Sinclair-LCB.jpg",
                color: '#FFD700',
                personalities: [
                    { name: "Девять协会北部3科", avatar: " images/Sinclair/Sinclair-Девять.webp" },
                    { name: "Zwei协会西部3科", avatar: "images/Sinclair/Sinclair-Zwei.webp" },
                    { name: "Zwei协会南部6科", avatar: "images/Sinclair/Sinclair-Zwei2.webp" },
                    { name: "LCB罪人", avatar: "images/Sinclair/Sinclair-LCB.jpg" },
                    { name: "Cinq协会南部4科科长", avatar: "images/Sinclair/Sinclair-Cinq.webp" },
                    { name: "准执柄者", avatar: "images/Sinclair/Sinclair-N.webp" },
                    { name: "中指幼弟", avatar: "images/Sinclair/Sinclair-zhong_zhi.webp" },
                    { name: "脑叶公司E.G.O:朱符", avatar: "images/Sinclair/Sinclair-zhu_fu.webp" },
                    { name: "拇指东部士兵II", avatar: "images/Sinclair/Sinclair-mu_zhi.webp" },
                    { name: "流浪乐队头目", avatar: "images/Sinclair/Sinclair-sha_chui.webp" },
                    { name: "黎明事务所收尾人", avatar: "images/Sinclair/Sinclair-lin_ming.webp" },
                    { name: "臼齿修船厂收尾人", avatar: "images/Sinclair/Sinclair-jiu_chi.webp" },
                    { name: "剑契组杀手", avatar: "images/Sinclair/Sinclair-jian_qi.webp" },
                    { name: "黑兽-酉", avatar: "images/Sinclair/Sinclair-ji.webp" }
                ]
            },
            {
                id: 11,
                name: "格里高尔 (Gregor)",
                avatar: "images/Gregor/Gregor-LCB.jpg",
                color: '#8B4513',
                personalities: [
                    { name: "Zwei协会南部4科", avatar: " images/Gregor/Gregor-Zwei.webp" },
                    { name: "LCB罪人", avatar: "images/Gregor/Gregor-LCB.jpg" },
                    { name: "G公司科长代理", avatar: "images/Gregor/Gregor-G.webp" },
                    { name: "夜锥组队长", avatar: "images/Gregor/Gregor-ye_zhui.webp" },
                    { name: "炎拳事务所幸存者", avatar: "images/Gregor/Gregor-yan_quan.webp" },
                    { name: "双钩海盗团大副", avatar: "images/Gregor/Gregor-shuang_gou.webp" },
                    { name: "玫瑰扳手工坊收尾人", avatar: "images/Gregor/Gregor-mei_gui.webp" },
                    { name: "六协会南部6科", avatar: "images/Gregor/Gregor-6.webp" },
                    { name: "良·派帮厨", avatar: "images/Gregor/Gregor-liang.webp" },
                    { name: "拉·曼却领神父", avatar: "images/Gregor/Gregor-la_manque.webp" },
                    { name: "黑云会副会长", avatar: "images/Gregor/Gregor-hei_yun.webp" },
                    { name: "黑兽-巳", avatar: "images/Gregor/Gregor-she.webp" },
                    { name: "埃德加家族继承人", avatar: "images/Gregor/Gregor-ai_dejia.webp" }
                ]
            },
            {
                id: 12,
                name: "奥提斯 (Outis)",
                avatar: "images/Outis/Outis-LCB.jpg",
                color: '#008080',
                personalities: [
                    { name: "W公司3级清扫组长", avatar: " images/Outis/Outis-W.webp" },
                    { name: "T公司3级强制征收人员", avatar: "images/Outis/Outis-T.webp" },
                    { name: "Seven协会南部6科科长", avatar: "images/Outis/Outis-Seven.webp" },
                    { name: "LCB罪人", avatar: "images/Outis/Outis-LCB.jpg" },
                    { name: "G公司部长", avatar: "images/Outis/Outis-G.webp" },
                    { name: "Cinq协会南部4科", avatar: "images/Outis/Outis-Cinq.webp" },
                    { name: "脑叶公司E.G.O:魔弹", avatar: "images/Outis/Outis-L.webp" },
                    { name: "拉·曼却领理发师", avatar: "images/Outis/Outis-la_manque.webp" },
                    { name: "臼齿事务所收尾人", avatar: "images/Outis/Outis-jiu_chi.webp" },
                    { name: "剑契组杀手", avatar: "images/Outis/Outis-jian_qi.webp" },
                    { name: "环指点彩派学徒", avatar: "images/Outis/Outis-huan_zhi.webp" },
                    { name: "呼啸山庄首席管家", avatar: "images/Outis/Outis-hu_xiao.webp" },
                    { name: "黑兽-卯", avatar: "images/Outis/Outis-tu.webp" }
                ]
            }
        ];

        // 获取DOM元素
        const sinnerScroll = document.getElementById('sinner-scroll');
        const personaScroll = document.getElementById('persona-scroll');
        const sinnerScrollContainer = document.getElementById('sinner-scroll-container');
        const personaScrollContainer = document.getElementById('persona-scroll-container');
        const sinnerStartBtn = document.getElementById('sinner-start-btn');
        const sinnerStopBtn = document.getElementById('sinner-stop-btn');
        const personaStartBtn = document.getElementById('persona-start-btn');
        const personaStopBtn = document.getElementById('persona-stop-btn');
        const selectedSinnerEl = document.getElementById('selected-sinner');
        const selectedPersonaEl = document.getElementById('selected-persona');

        // 页面导航元素
        const mainPageBtn = document.getElementById('main-page-btn');
        const settingsPageBtn = document.getElementById('settings-page-btn');
        const mainSelectorPage = document.getElementById('main-selector-page');
        const settingsPage = document.getElementById('settings-page');

        // 滚动状态
        let sinnerScrollInterval = null;
        let personaScrollInterval = null;
        let currentSelectedSinner = null;
        let sinnerItems = [];
        let personaItems = [];
        let sinnerOffset = 0;
        let personaOffset = 0;
        let isSinnerScrolling = false;
        let isPersonaScrolling = false;
        const itemHeight = 50; // 每个项目高度

        // 新增变量：筛选后的罪人数据
        let filteredSinnerData = [...sinnerData]; // 默认包含所有罪人
        
        // 新增变量：筛选后的人格数据
        let filteredPersonalityData = {};

        // 新增变量：存储原始筛选状态，用于检测是否有更改
        let originalFilteredSinnerData = [];
        let originalFilteredPersonalityData = {};
        let hasUnsavedChanges = false;

        // 页面导航功能
        mainPageBtn.addEventListener('click', () => {
            if (!checkUnsavedChanges()) {
                return; // 用户选择取消操作
            }
            
            // 检查是否满足保底条件
            if (!validateFilterSettings()) {
                return; // 不满足保底条件，阻止返回主页面
            }
            
            mainSelectorPage.style.display = 'block';
            settingsPage.style.display = 'none';
            mainPageBtn.classList.add('active');
            settingsPageBtn.classList.remove('active');
            refreshScrollsOnReturn();
        });

        settingsPageBtn.addEventListener('click', () => {
            mainSelectorPage.style.display = 'none';
            settingsPage.style.display = 'block';
            settingsPageBtn.classList.add('active');
            mainPageBtn.classList.remove('active');
            createPersonalitySettings();
        });

        // 创建滚动列表
        function createSinnerScrollList(items) {
            sinnerScroll.innerHTML = '';
            sinnerItems = items;
            
            // 计算显示行数 (最小1行，最大5行)
            const visibleRows = Math.min(Math.max(items.length, 1), 5);
            const containerHeight = visibleRows * itemHeight;
            sinnerScrollContainer.style.height = `${containerHeight}px`;
            
            // 如果只有一个项目，禁用二级转盘开始按钮
            personaStartBtn.disabled = items.length === 1;
            
            // 创建足够多的项目以实现平滑滚动效果
            const itemCount = items.length * 10;
            for (let i = 0; i < itemCount; i++) {
                const item = document.createElement('div');
                item.className = 'scroll-item';
                item.style.height = `${itemHeight}px`;
                item.dataset.originalIndex = i % items.length; // 存储原始索引
                
                const content = document.createElement('div');
                content.className = 'scroll-item-content';
                
                // 创建头像元素
                const avatarElement = document.createElement('img');
                avatarElement.className = 'avatar-placeholder';
                avatarElement.style.width = '30px';
                avatarElement.style.height = '30px';
                const sinnerInfo = sinnerData.find(s => s.name === items[i % items.length]);
                if (sinnerInfo && sinnerInfo.avatar) {
                    avatarElement.src = sinnerInfo.avatar;
                    avatarElement.alt = sinnerInfo.name;
                    avatarElement.onerror = function() {
                        this.textContent = '?';
                        this.style.display = 'flex';
                        this.style.alignItems = 'center';
                        this.style.justifyContent = 'center';
                    };
                } else {
                    avatarElement.textContent = '?';
                }
                content.appendChild(avatarElement);
                
                const textSpan = document.createElement('span');
                textSpan.textContent = items[i % items.length];
                content.appendChild(textSpan);
                
                item.appendChild(content);
                sinnerScroll.appendChild(item);
            }
            
            // 设置scroll-list的高度，确保所有项目都能被滚动到
            sinnerScroll.style.height = `${itemCount * itemHeight}px`;
            
            // 如果只有一个项目，直接高亮显示
            if (items.length === 1) {
                setTimeout(() => {
                    highlightSelectedItem(sinnerScroll, 0);
                }, 100);
            }
        }

        // 创建人格滚动列表
        function createPersonaScrollList(items) {
            console.log('createPersonaScrollList被调用，items:', items);
            // 确保items是一个数组
            if (!Array.isArray(items)) {
                console.error('createPersonaScrollList: items必须是一个数组');
                return;
            }
            
            personaScroll.innerHTML = '';
            personaItems = items;
            
            // 计算显示行数 (最小1行，最大5行)
            const visibleRows = Math.min(Math.max(items.length, 1), 5);
            const containerHeight = visibleRows * itemHeight;
            personaScrollContainer.style.height = `${containerHeight}px`;
            
            // 特殊处理：如果是提示字符串，则不循环创建
            if (items.length === 1 && typeof items[0] === 'string') {
                const item = document.createElement('div');
                item.className = 'scroll-item';
                item.style.height = `${itemHeight}px`;
                
                const content = document.createElement('div');
                content.className = 'scroll-item-content';
                
                const avatarElement = document.createElement('img');
                avatarElement.className = 'avatar-placeholder';
                avatarElement.style.width = '30px';
                avatarElement.style.height = '30px';
                avatarElement.src = './limbuspersona/question.png';
                avatarElement.alt = '未知头像';
                content.appendChild(avatarElement);
                
                const textSpan = document.createElement('span');
                textSpan.textContent = items[0];
                content.appendChild(textSpan);
                
                item.appendChild(content);
                personaScroll.appendChild(item);
                
                personaStartBtn.disabled = true;
                return;
            }
            
            // 如果没有项目，显示提示
            if (items.length === 0) {
                const item = document.createElement('div');
                item.className = 'scroll-item';
                item.style.height = `${itemHeight}px`;
                
                const content = document.createElement('div');
                content.className = 'scroll-item-content';
                
                const avatarElement = document.createElement('img');
                avatarElement.className = 'avatar-placeholder';
                avatarElement.style.width = '30px';
                avatarElement.style.height = '30px';
                avatarElement.src = './limbuspersona/question.png';
                avatarElement.alt = '未知头像';
                content.appendChild(avatarElement);
                
                const textSpan = document.createElement('span');
                textSpan.textContent = '请先选择罪人';
                content.appendChild(textSpan);
                
                item.appendChild(content);
                personaScroll.appendChild(item);
                
                personaStartBtn.disabled = true;
                return;
            }
            
            // 如果只有一个人格，禁用开始按钮
            personaStartBtn.disabled = items.length === 1;
            
            // 创建足够多的项目以实现平滑滚动效果
            const itemCount = items.length * 10;
            for (let i = 0; i < itemCount; i++) {
                const item = document.createElement('div');
                item.className = 'scroll-item';
                item.style.height = `${itemHeight}px`;
                item.dataset.originalIndex = i % items.length;
                
                const content = document.createElement('div');
                content.className = 'scroll-item-content';
                
                // 创建头像元素
                const avatarElement = document.createElement('img');
                avatarElement.className = 'avatar-placeholder';
                avatarElement.style.width = '30px';
                avatarElement.style.height = '30px';
                
                // 获取人格信息
                const personaInfo = items[i % items.length];
                if (personaInfo && personaInfo.image) {
                    avatarElement.src = `./limbuspersona/${personaInfo.image}`;
                    avatarElement.alt = personaInfo.name;
                    avatarElement.onerror = function() {
                        this.src = './limbuspersona/question.png';
                        this.alt = '未知头像';
                    };
                } else if (personaInfo && personaInfo.avatar) {
                    avatarElement.src = personaInfo.avatar;
                    avatarElement.alt = personaInfo.name;
                    avatarElement.onerror = function() {
                        this.src = './limbuspersona/question.png';
                        this.alt = '未知头像';
                    };
                } else {
                    avatarElement.src = './limbuspersona/question.png';
                    avatarElement.alt = '未知头像';
                }
                content.appendChild(avatarElement);
                
                const textSpan = document.createElement('span');
                textSpan.textContent = items[i % items.length].name;
                content.appendChild(textSpan);
                
                item.appendChild(content);
                personaScroll.appendChild(item);
            }
            
            // 设置scroll-list的高度，确保所有项目都能被滚动到
            personaScroll.style.height = `${itemCount * itemHeight}px`;
            
            // 如果只有一个项目，直接高亮显示
            if (items.length === 1) {
                console.log('只有一个项目，直接高亮显示');
                
                // 确保DOM元素已创建完成后再执行高亮
                setTimeout(() => {
                    highlightSelectedItem(personaScroll, 0);
                    // 直接选择该人格
                    currentSelectedPersona = items[0];
                    console.log('当前选中人格:', currentSelectedPersona);
                    if (currentSelectedPersona && currentSelectedPersona.name) {
                        selectedPersonaEl.textContent = currentSelectedPersona.name;
                        console.log('selectedPersonaEl文本设置为:', currentSelectedPersona.name);
                    } else {
                        console.error('当前选中人格无效:', currentSelectedPersona);
                        selectedPersonaEl.textContent = '未选择';
                    }
                    personaStartBtn.disabled = true;
                }, 0); // 使用0延迟确保在DOM更新后执行
            } else {
                personaStartBtn.disabled = false;
            }
        }

        // 开始罪人滚动
        function startSinnerScroll() {
            if (filteredSinnerData.length < 1) {
                alert('请至少选择一个罪人！');
                return;
            }
            
            // 当罪人数量为1时，直接调用停止函数选择该罪人，不启动滚动
            if (filteredSinnerData.length === 1) {
                stopSinnerScroll();
                return;
            }
            
            if (sinnerScrollInterval) return;
            
            sinnerStartBtn.disabled = true;
            sinnerStopBtn.disabled = false;
            isSinnerScrolling = true;
            
            // 清除之前选中的高亮
            clearHighlight(sinnerScroll);
            
            // 快速滚动
            const speed = 150;
            sinnerScroll.style.transition = 'transform 0.05s linear';
            
            sinnerScrollInterval = setInterval(() => {
                sinnerOffset += speed;
                sinnerScroll.style.transform = `translateY(-${sinnerOffset}px)`;
                
                // 循环重置逻辑
                const totalHeight = sinnerItems.length * itemHeight * 5;
                if (sinnerOffset > totalHeight) {
                    sinnerOffset = sinnerOffset % totalHeight;
                    sinnerScroll.style.transition = 'none';
                    sinnerScroll.style.transform = `translateY(-${sinnerOffset}px)`;
                    setTimeout(() => {
                        sinnerScroll.style.transition = 'transform 0.05s linear';
                    }, 10);
                }
            }, 10);
        }

 // 重置二级转盘状态
        function resetPersonaScrollState() {
            // 清除滚动间隔
            if (personaScrollInterval) {
                clearInterval(personaScrollInterval);
                personaScrollInterval = null;
            }
            
            // 重置滚动状态
            isPersonaScrolling = false;
            personaOffset = 0;
            
            // 重置滚动容器的样式
            personaScroll.style.transition = '';
            personaScroll.style.transform = '';
            
            // 重置按钮状态
            personaStopBtn.disabled = true;
            
            // 初始化当前选中的罪人人格
            currentSelectedPersona = null;
            selectedPersonaEl.textContent = '未选择';
        }

        // 停止罪人滚动并定位到中心
        function stopSinnerScroll() {
            // 如果只有一个罪人，直接选中
            if (filteredSinnerData.length <= 1) {
                if (filteredSinnerData.length === 0) {
                    alert('请至少选择一个罪人！');
                    return;
                }
                
                // 直接选中唯一罪人
                currentSelectedSinner = filteredSinnerData[0];
                selectedSinnerEl.textContent = currentSelectedSinner.name;
                selectedPersonaEl.textContent = "未选择";
                
                // 高亮显示
                highlightSelectedItem(sinnerScroll, sinnerData.findIndex(s => s.id === currentSelectedSinner.id));
                
                // 重置二级转盘状态
                resetPersonaScrollState();
                
                // 创建对应罪人的人格列表
    console.log('当前选中罪人:', currentSelectedSinner);
    console.log('人格筛选数据:', filteredPersonalityData[currentSelectedSinner.id]);
    
    // 重置当前罪人的筛选状态（解决从多人格切换到单人格时的问题）
    filteredPersonalityData[currentSelectedSinner.id] = {};
    // 默认选择所有人格
    currentSelectedSinner.personalities.forEach((_, index) => {
        filteredPersonalityData[currentSelectedSinner.id][index] = true;
    });
    
    const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
        // 如果没有设置该人格的筛选状态，默认为true
        const isSelected = filteredPersonalityData[currentSelectedSinner.id][index] !== false;
        console.log(`人格${index} (${persona.name}) 筛选状态: ${isSelected}`);
        return isSelected;
    });
    
    console.log('过滤后的人格:', filteredPersonalities);
                
                // 确保personasToShow始终是人格对象数组
                const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : [];
                console.log('即将显示的人格:', personasToShow);
                createPersonaScrollList(personasToShow);
                
                return;
            }
            
            if (!sinnerScrollInterval) return;
            
            clearInterval(sinnerScrollInterval);
            sinnerScrollInterval = null;
            isSinnerScrolling = false;
            
            // 从筛选后的罪人中随机选择
            if (filteredSinnerData.length === 0) {
                alert('请至少选择一个罪人！');
                sinnerStartBtn.disabled = false;
                sinnerStopBtn.disabled = true;
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * filteredSinnerData.length);
            currentSelectedSinner = filteredSinnerData[randomIndex];
            selectedSinnerEl.textContent = currentSelectedSinner.name;
            selectedPersonaEl.textContent = "未选择";
            
            // 计算在原始sinnerData中的索引用于定位
            const originalIndex = sinnerData.findIndex(s => s.id === currentSelectedSinner.id);
            
            // 计算显示行数和中心行索引
            const visibleRows = Math.min(Math.max(filteredSinnerData.length, 1), 5);
            const centerIndex = Math.floor(visibleRows / 2);
            const centerOffset = centerIndex * itemHeight;
            
            // 计算目标偏移量，确保选中项显示在中心行
            const loopCount = 5; // 使用第5次循环的项目进行定位，确保前后都有足够项目
            const targetOffset = (originalIndex + loopCount * sinnerItems.length) * itemHeight - centerOffset;
            
            // 平滑过渡到目标位置
            sinnerScroll.style.transition = 'transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)';
            sinnerScroll.style.transform = `translateY(-${targetOffset}px)`;
            
            // 更新当前偏移量
            sinnerOffset = targetOffset;
            
            // 高亮显示选中的项目
            setTimeout(() => {
                highlightSelectedItem(sinnerScroll, originalIndex);
            }, 800); // 等待过渡动画完成
            
            sinnerStartBtn.disabled = false;
            sinnerStopBtn.disabled = true;
            
            // 人格选择按钮状态由createPersonaScrollList函数自动处理
            // personaStartBtn.disabled = false;
            
            // 重置二级转盘状态
            resetPersonaScrollState();
            
            // 创建对应罪人的人格列表，仅包含已筛选的人格
            console.log('当前选中罪人:', currentSelectedSinner);
            console.log('人格筛选数据:', filteredPersonalityData[currentSelectedSinner.id]);
            
            // 确保filteredPersonalityData中存在该罪人的数据
            if (!filteredPersonalityData[currentSelectedSinner.id]) {
                filteredPersonalityData[currentSelectedSinner.id] = {};
                // 默认选择所有人格
                currentSelectedSinner.personalities.forEach((_, index) => {
                    filteredPersonalityData[currentSelectedSinner.id][index] = true;
                });
            }
            
            const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
                // 如果没有设置该人格的筛选状态，默认为true
                const isSelected = filteredPersonalityData[currentSelectedSinner.id][index] !== false;
                console.log(`人格${index} (${persona.name}) 筛选状态: ${isSelected}`);
                return isSelected;
            });
            
            console.log('过滤后的人格:', filteredPersonalities);
            
            // 如果没有筛选的人格，则显示提示信息
            const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : ['请先选择人格'];
            createPersonaScrollList(personasToShow);
        }

        // 开始人格滚动
        function startPersonaScroll() {
            // 检查当前是否有选中的罪人
            if (!currentSelectedSinner) {
                alert('请先选择一个罪人！');
                return;
            }
            
            // 检查当前罪人的人格数量
            const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
                return filteredPersonalityData[currentSelectedSinner.id] && 
                       filteredPersonalityData[currentSelectedSinner.id][index] !== false;
            });
            
            const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : ['请先选择人格'];
            if (personasToShow.length < 1) {
                alert('请至少选择一个人格！');
                return;
            }
            
            // 当人格数量为1时，直接调用停止函数选择该人格，不启动滚动
            if (personasToShow.length === 1) {
                stopPersonaScroll();
                return;
            }
            
            if (personaScrollInterval) return;
            
            personaStartBtn.disabled = true;
            personaStopBtn.disabled = false;
            isPersonaScrolling = true;
            
            // 清除之前选中的高亮
            clearHighlight(personaScroll);
            
            // 快速滚动
            const speed = 150;
            personaScroll.style.transition = 'transform 0.05s linear';
            
            personaScrollInterval = setInterval(() => {
                personaOffset += speed;
                personaScroll.style.transform = `translateY(-${personaOffset}px)`;
                
                // 循环重置逻辑
                const totalHeight = personaItems.length * itemHeight * 5;
                if (personaOffset > totalHeight) {
                    personaOffset = personaOffset % totalHeight;
                    personaScroll.style.transition = 'none';
                    personaScroll.style.transform = `translateY(-${personaOffset}px)`;
                    setTimeout(() => {
                        personaScroll.style.transition = 'transform 0.05s linear';
                    }, 10);
                }
            }, 10);
        }

        // 停止人格滚动并定位到中心
        function stopPersonaScroll() {
            // 检查当前罪人的人格数量
            if (currentSelectedSinner) {
                const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
                    return filteredPersonalityData[currentSelectedSinner.id] && 
                           filteredPersonalityData[currentSelectedSinner.id][index] !== false;
                });
                
                const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : ['请先选择人格'];
                if (personasToShow.length <= 1) {
                    // 直接选中唯一人格（如果有的话）
                    if (personasToShow.length === 0) {
                        alert('请至少选择一个人格！');
                        return;
                    }
                    
                    const selectedPersona = personasToShow[0];
                    selectedPersonaEl.textContent = typeof selectedPersona === 'object' ? selectedPersona.name : selectedPersona;
                    
                    // 高亮显示
                    highlightSelectedItem(personaScroll, 0);
                    
                    // 当只有一个人格时，禁用开始按钮（与createPersonaScrollList保持一致）
                    personaStartBtn.disabled = personasToShow.length === 1;
                    personaStopBtn.disabled = true;
                    return;
                }
            }
            
            if (!personaScrollInterval || !currentSelectedSinner) return;
            
            clearInterval(personaScrollInterval);
            personaScrollInterval = null;
            isPersonaScrolling = false;
            
            // 获取筛选后的人格列表
            const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
                return filteredPersonalityData[currentSelectedSinner.id] && 
                       filteredPersonalityData[currentSelectedSinner.id][index] !== false;
            });
            
            const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : ['请先选择人格'];
            
            // 检查是否有人格被选中
            if (personasToShow.length === 0) {
                alert('请至少选择一个人格！');
                personaStartBtn.disabled = false;
                personaStopBtn.disabled = true;
                return;
            }
            
            // 随机选择一个人格
            const randomIndex = Math.floor(Math.random() * personasToShow.length);
            const selectedPersona = personasToShow[randomIndex];
            selectedPersonaEl.textContent = typeof selectedPersona === 'object' ? selectedPersona.name : selectedPersona;
            
            // 计算显示行数和中心行索引
            const visibleRows = Math.min(Math.max(personasToShow.length, 1), 5);
            const centerIndex = Math.floor(visibleRows / 2);
            const centerOffset = centerIndex * itemHeight;
            
            // 计算目标偏移量，确保选中项显示在中心行
            const loopCount = 5; // 使用第5次循环的项目进行定位
            const targetOffset = (randomIndex + loopCount * personasToShow.length) * itemHeight - centerOffset;
            
            // 平滑过渡到目标位置
            personaScroll.style.transition = 'transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)';
            personaScroll.style.transform = `translateY(-${targetOffset}px)`;
            
            // 更新当前偏移量
            personaOffset = targetOffset;
            
            // 高亮显示选中的项目
            setTimeout(() => {
                highlightSelectedItem(personaScroll, randomIndex);
            }, 800); // 等待过渡动画完成
            
            personaStartBtn.disabled = false;
            personaStopBtn.disabled = true;
        }

        // 清除高亮显示
        function clearHighlight(scrollContainer) {
            const items = scrollContainer.querySelectorAll('.scroll-item');
            items.forEach(item => {
                item.classList.remove('selected');
            });
        }

        // 高亮显示选中项
        function highlightSelectedItem(scrollContainer, index) {
            clearHighlight(scrollContainer);
            const items = scrollContainer.querySelectorAll('.scroll-item');
            items.forEach(item => {
                const itemOriginalIndex = parseInt(item.dataset.originalIndex);
                // 查找与给定索引匹配的项目（考虑到重复的项目）
                if (itemOriginalIndex === index) {
                    item.classList.add('selected');
                }
            });
        }

        // 创建罪人筛选复选框
        function createSinnerFilter() {
            const filterContainer = document.getElementById('sinner-filter');
            filterContainer.innerHTML = '';
            
            sinnerData.forEach(sinner => {
                const label = document.createElement('label');
                label.className = 'sinner-checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = sinner.id;
                checkbox.checked = true; // 默认全选
                checkbox.addEventListener('change', updateFilteredSinnerData);
                
                // 创建头像元素
                if (sinner.avatar) {
                    const avatarImg = document.createElement('img');
                    avatarImg.className = 'filter-avatar';
                    avatarImg.style.width = '20px';
                    avatarImg.style.height = '20px';
                    avatarImg.src = sinner.avatar;
                    avatarImg.alt = sinner.name;
                    avatarImg.onerror = function() {
                        // 如果图片加载失败，显示占位符
                        this.parentNode.replaceChild(createAvatarPlaceholder(sinner), this);
                    };
                    label.appendChild(checkbox);
                    label.appendChild(avatarImg);
                } else {
                    const placeholder = createAvatarPlaceholder(sinner);
                    label.appendChild(checkbox);
                    label.appendChild(placeholder);
                }
                
                label.appendChild(document.createTextNode(sinner.name));
                
                filterContainer.appendChild(label);
            });
        }

        // 人格筛选的全选/全不选功能
        function toggleAllPersonalities(selectAll) {
            const allCheckboxes = document.querySelectorAll('#personality-settings-container input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                // 触发change事件以更新内部状态
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // 人格筛选的反选功能
        function invertAllPersonalities() {
            const allCheckboxes = document.querySelectorAll('#personality-settings-container input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
                // 触发change事件以更新内部状态
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // 特定罪人的全选/全不选功能
        function toggleSinnerPersonalities(sinnerId, selectAll) {
            const sinnerCheckboxes = document.querySelectorAll(`#personality-settings-container .personality-page[data-sinner-id="${sinnerId}"] input[type="checkbox"]`);
            sinnerCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                // 触发change事件以更新内部状态
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // 特定罪人的反选功能
        function invertSinnerPersonalities(sinnerId) {
            const sinnerCheckboxes = document.querySelectorAll(`#personality-settings-container .personality-page[data-sinner-id="${sinnerId}"] input[type="checkbox"]`);
            sinnerCheckboxes.forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
                // 触发change事件以更新内部状态
                checkbox.dispatchEvent(new Event('change'));
            });
        }

  // 创建人格筛选设置（分页形式）
        function createPersonalitySettings() {
            const container = document.getElementById('personality-settings-container');
            container.innerHTML = '';
            
            // 获取当前选中的罪人ID列表
            const selectedSinnerCheckboxes = document.querySelectorAll('#sinner-filter input[type="checkbox"]:checked');
            const selectedSinnerIds = Array.from(selectedSinnerCheckboxes).map(cb => parseInt(cb.value));
            
            // 添加全局控制按钮
            const globalControlDiv = document.createElement('div');
            globalControlDiv.className = 'filter-controls';
            globalControlDiv.style.marginBottom = '20px';
            
            const selectAllBtn = document.createElement('button');
            selectAllBtn.className = 'control-btn';
            selectAllBtn.style.margin = '10px 5px';
            selectAllBtn.style.padding = '8px 15px';
            selectAllBtn.style.fontSize = '0.9rem';
            selectAllBtn.textContent = '全选所有人格';
            selectAllBtn.addEventListener('click', () => toggleAllPersonalities(true));
            
            const deselectAllBtn = document.createElement('button');
            deselectAllBtn.className = 'control-btn';
            deselectAllBtn.style.margin = '10px 5px';
            deselectAllBtn.style.padding = '8px 15px';
            deselectAllBtn.style.fontSize = '0.9rem';
            deselectAllBtn.textContent = '全不选所有人格';
            deselectAllBtn.addEventListener('click', () => toggleAllPersonalities(false));
            
            const invertSelectionBtn = document.createElement('button');
            invertSelectionBtn.className = 'control-btn';
            invertSelectionBtn.style.margin = '10px 5px';
            invertSelectionBtn.style.padding = '8px 15px';
            invertSelectionBtn.style.fontSize = '0.9rem';
            invertSelectionBtn.textContent = '反选所有人格';
            invertSelectionBtn.addEventListener('click', invertAllPersonalities);
            
            globalControlDiv.appendChild(selectAllBtn);
            globalControlDiv.appendChild(deselectAllBtn);
            globalControlDiv.appendChild(invertSelectionBtn);
            container.appendChild(globalControlDiv);
            
            // 如果有选中的罪人，创建对应的人格设置页面
            if (selectedSinnerIds.length > 0) {
                // 创建分页容器
                const paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination';
                paginationContainer.id = 'personality-pagination';
                
                // 创建人格页面
                let firstPage = true;
                selectedSinnerData = sinnerData.filter(sinner => selectedSinnerIds.includes(sinner.id));
                
                selectedSinnerData.forEach((sinner, sinnerIndex) => {
                    // 创建页面容器
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'personality-page';
                    pageDiv.dataset.sinnerId = sinner.id;
                    if (firstPage) {
                        pageDiv.classList.add('active');
                        firstPage = false;
                    }
                    
                    // 创建页面标题
                    const pageTitle = document.createElement('h4');
                    pageTitle.className = 'settings-section-title';
                    pageTitle.innerHTML = `<i class="fas fa-user"></i> ${sinner.name}`;
                    pageDiv.appendChild(pageTitle);
                    
                    // 创建页面控制按钮
                    const pageControlDiv = document.createElement('div');
                    pageControlDiv.className = 'filter-controls';
                    pageControlDiv.style.marginBottom = '20px';
                    
                    const pageSelectAllBtn = document.createElement('button');
                    pageSelectAllBtn.className = 'control-btn';
                    pageSelectAllBtn.style.margin = '10px 5px';
                    pageSelectAllBtn.style.padding = '8px 15px';
                    pageSelectAllBtn.style.fontSize = '0.9rem';
                    pageSelectAllBtn.textContent = '全选';
                    pageSelectAllBtn.dataset.sinnerId = sinner.id;
                    pageSelectAllBtn.addEventListener('click', (e) => {
                        toggleSinnerPersonalities(parseInt(e.target.dataset.sinnerId), true);
                    });
                    
                    const pageDeselectAllBtn = document.createElement('button');
                    pageDeselectAllBtn.className = 'control-btn';
                    pageDeselectAllBtn.style.margin = '10px 5px';
                    pageDeselectAllBtn.style.padding = '8px 15px';
                    pageDeselectAllBtn.style.fontSize = '0.9rem';
                    pageDeselectAllBtn.textContent = '全不选';
                    pageDeselectAllBtn.dataset.sinnerId = sinner.id;
                    pageDeselectAllBtn.addEventListener('click', (e) => {
                        toggleSinnerPersonalities(parseInt(e.target.dataset.sinnerId), false);
                    });
                    
                    const pageInvertBtn = document.createElement('button');
                    pageInvertBtn.className = 'control-btn';
                    pageInvertBtn.style.margin = '10px 5px';
                    pageInvertBtn.style.padding = '8px 15px';
                    pageInvertBtn.style.fontSize = '0.9rem';
                    pageInvertBtn.textContent = '反选';
                    pageInvertBtn.dataset.sinnerId = sinner.id;
                    pageInvertBtn.addEventListener('click', (e) => {
                        invertSinnerPersonalities(parseInt(e.target.dataset.sinnerId));
                    });
                    
                    pageControlDiv.appendChild(pageSelectAllBtn);
                    pageControlDiv.appendChild(pageDeselectAllBtn);
                    pageControlDiv.appendChild(pageInvertBtn);
                    pageDiv.appendChild(pageControlDiv);
                    
                    // 创建人格网格
                    const personalityGrid = document.createElement('div');
                    personalityGrid.className = 'personality-settings-grid';
                    
                    sinner.personalities.forEach((persona, index) => {
                        const card = document.createElement('div');
                        card.className = 'personality-setting-card';
                        
                        const avatar = document.createElement('img');
                        avatar.className = 'personality-avatar';
                        avatar.style.width = '60px';
                        avatar.style.height = '60px';
                        if (persona.avatar) {
                            avatar.src = persona.avatar;
                            avatar.alt = persona.name;
                            avatar.onerror = function() {
                                this.textContent = '?';
                                this.style.display = 'flex';
                                this.style.alignItems = 'center';
                                this.style.justifyContent = 'center';
                            };
                        } else {
                            avatar.textContent = '?';
                            avatar.style.display = 'flex';
                            avatar.style.alignItems = 'center';
                            avatar.style.justifyContent = 'center';
                        }
                        
                        const name = document.createElement('div');
                        name.className = 'personality-name';
                        name.textContent = persona.name;
                        
                        const toggle = document.createElement('label');
                        toggle.className = 'personality-toggle';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        // 检查是否已经设置过筛选状态，如果有则使用，否则默认为true
                        checkbox.checked = filteredPersonalityData[sinner.id] ? 
                                          (filteredPersonalityData[sinner.id][index] !== false) : 
                                          true;
                        checkbox.dataset.sinnerId = sinner.id;
                        checkbox.dataset.personaIndex = index;
                        checkbox.addEventListener('change', updatePersonalityFilter);
                        
                        const toggleText = document.createElement('span');
                        toggleText.textContent = '启用';
                        
                        toggle.appendChild(checkbox);
                        toggle.appendChild(toggleText);
                        
                        card.appendChild(avatar);
                        card.appendChild(name);
                        card.appendChild(toggle);
                        
                        personalityGrid.appendChild(card);
                    });
                    
                    pageDiv.appendChild(personalityGrid);
                    container.appendChild(pageDiv);
                    
                    // 创建分页按钮
                    const pageBtn = document.createElement('button');
                    pageBtn.className = 'page-btn';
                    pageBtn.textContent = sinnerIndex + 1;
                    pageBtn.dataset.sinnerId = sinner.id;
                    if (firstPage === false && sinnerIndex === 0) {
                        pageBtn.classList.add('active');
                    }
                    pageBtn.addEventListener('click', (e) => {
                        // 切换页面
                        document.querySelectorAll('.personality-page').forEach(page => {
                            page.classList.remove('active');
                        });
                        document.querySelectorAll('.page-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        const targetSinnerId = e.target.dataset.sinnerId;
                        document.querySelector(`.personality-page[data-sinner-id="${targetSinnerId}"]`).classList.add('active');
                        e.target.classList.add('active');
                    });
                    
                    paginationContainer.appendChild(pageBtn);
                });
                
                container.appendChild(paginationContainer);
            } else {
                // 如果没有选中的罪人，显示提示信息
                const noSinnerMsg = document.createElement('p');
                noSinnerMsg.textContent = '请先在罪人筛选设置中选择至少一个罪人';
                noSinnerMsg.style.textAlign = 'center';
                noSinnerMsg.style.color = '#aaa';
                noSinnerMsg.style.marginTop = '20px';
                container.appendChild(noSinnerMsg);
            }
        }
        // 更新人格筛选
        function updatePersonalityFilter(event) {
            const checkbox = event.target;
            const sinnerId = parseInt(checkbox.dataset.sinnerId);
            const personaIndex = parseInt(checkbox.dataset.personaIndex);
            
            // 初始化该罪人的筛选数据
            if (!filteredPersonalityData[sinnerId]) {
                filteredPersonalityData[sinnerId] = {};
            }
            
            // 更新该人格的筛选状态
            filteredPersonalityData[sinnerId][personaIndex] = checkbox.checked;
            
            hasUnsavedChanges = true;
        }

        // 辅助函数：创建头像占位符
        function createAvatarPlaceholder(sinner) {
            const placeholder = document.createElement('span');
            placeholder.className = 'filter-avatar-placeholder';
            placeholder.style.width = '20px';
            placeholder.style.height = '20px';
            placeholder.style.backgroundColor = sinner.color;
            placeholder.textContent = '?';
            return placeholder;
        }

         // 更新筛选后的罪人数据
        function updateFilteredSinnerData() {
            const checkboxes = document.querySelectorAll('#sinner-filter input[type="checkbox"]');
            const selectedIds = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));
            
            filteredSinnerData = sinnerData.filter(sinner => selectedIds.includes(sinner.id));
            
            // 如果没有选中任何罪人或只有一个罪人，禁用开始按钮
            sinnerStartBtn.disabled = selectedIds.length === 0 || filteredSinnerData.length === 1;
            
            hasUnsavedChanges = true;
            
            // 如果当前在设置页面，更新人格设置显示
            if (settingsPage.style.display !== 'none') {
                createPersonalitySettings();
            }
        }
        // 全选/全不选
        function toggleAllCheckboxes(selectAll) {
            const checkboxes = document.querySelectorAll('#sinner-filter input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = selectAll);
            updateFilteredSinnerData();
            
            // 更新人格设置显示
            if (document.getElementById('settings-page').style.display !== 'none') {
                createPersonalitySettings();
            }
        }

        // 反选
        function invertSelection() {
            const checkboxes = document.querySelectorAll('#sinner-filter input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = !cb.checked);
            updateFilteredSinnerData();
            
            // 更新人格设置显示
            if (document.getElementById('settings-page').style.display !== 'none') {
                createPersonalitySettings();
            }
        }

        // 验证筛选设置是否满足保底条件
        function validateFilterSettings() {
            // 检查是否至少选择了一个罪人
            if (filteredSinnerData.length === 0) {
                alert('请至少选择一个罪人！');
                return false;
            }
            
            // 检查每个罪人是否至少选择了一个人格
            const sinnersWithoutPersonalities = [];
            for (const sinner of filteredSinnerData) {
                let hasPersonality = false;
                if (filteredPersonalityData[sinner.id]) {
                    // 检查该罪人的人格对象中是否有值为true的人格
                    hasPersonality = Object.values(filteredPersonalityData[sinner.id]).some(value => value === true);
                } else {
                    // 如果没有为该罪人设置人格筛选（初始状态），则默认认为所有人格都被选择
                    hasPersonality = true;
                }
                
                if (!hasPersonality) {
                    sinnersWithoutPersonalities.push(sinner.name);
                }
            }
            
            if (sinnersWithoutPersonalities.length > 0) {
                if (sinnersWithoutPersonalities.length === 1) {
                    alert(`请为罪人"${sinnersWithoutPersonalities[0]}"至少选择一个人格！`);
                } else {
                    alert(`请为以下罪人至少选择一个人格：\n${sinnersWithoutPersonalities.join('\n')}`);
                }
                return false;
            }
            
            return true;
        }
        
        // 应用筛选设置
        function applyFilters() {
            // 验证筛选设置是否满足保底条件
            if (!validateFilterSettings()) {
                return false;
            }
            
            // 保存当前筛选状态为原始状态
            originalFilteredSinnerData = [...filteredSinnerData];
            originalFilteredPersonalityData = JSON.parse(JSON.stringify(filteredPersonalityData));
            hasUnsavedChanges = false;
            
            // 更新主页面的滚动列表
            refreshScrollsOnReturn();
            
            // 应用成功后跳转到选取界面
            mainSelectorPage.style.display = 'block';
            settingsPage.style.display = 'none';
            mainPageBtn.classList.add('active');
            settingsPageBtn.classList.remove('active');
            
            alert('筛选设置已应用');
            return true;
        }

        // 检查是否有未保存的更改
        function checkUnsavedChanges() {
            if (hasUnsavedChanges) {
                if (confirm('您有未保存的更改，是否要保存后再离开？')) {
                    // 用户选择保存，执行保存操作
                    return applyFilters();
                }
                // 用户选择不保存，检查是否满足保底条件
                return validateFilterSettings();
            }
            // 没有未保存的更改，直接检查保底条件
            return validateFilterSettings();
        }

        // 返回主页面时更新转盘内容
        function refreshScrollsOnReturn() {
            // 更新一级转盘
            const sinnerNames = filteredSinnerData.map(sinner => sinner.name);
            createSinnerScrollList(sinnerNames);
            
            // 重置选中状态 - 但如果只有一个项目，不清除高亮
            if (filteredSinnerData.length !== 1) {
                clearHighlight(sinnerScroll);
                selectedSinnerEl.textContent = "未选择";
                // 只有当有多个罪人时，才重置人格选中状态
                selectedPersonaEl.textContent = "未选择";
            }
            
            // 如果没有罪人或只有一个罪人，禁用一级转盘开始按钮
            sinnerStartBtn.disabled = filteredSinnerData.length === 0 || filteredSinnerData.length === 1;
            sinnerStopBtn.disabled = true;
            personaStartBtn.disabled = true;
            personaStopBtn.disabled = true;
            
            // 如果只有一个罪人，自动设置为当前选中
            if (filteredSinnerData.length === 1) {
                currentSelectedSinner = filteredSinnerData[0];
                selectedSinnerEl.textContent = currentSelectedSinner.name;
                
                // 获取筛选后的人格列表
                console.log('从设置页面返回，自动选中的罪人:', currentSelectedSinner);
                console.log('该罪人的人格筛选数据:', filteredPersonalityData[currentSelectedSinner.id]);
                
                // 确保filteredPersonalityData中存在该罪人的数据
                if (!filteredPersonalityData[currentSelectedSinner.id]) {
                    filteredPersonalityData[currentSelectedSinner.id] = {};
                    // 默认选择所有人格
                    currentSelectedSinner.personalities.forEach((_, index) => {
                        filteredPersonalityData[currentSelectedSinner.id][index] = true;
                    });
                }
                
                const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
                    // 如果没有设置该人格的筛选状态，默认为true
                    const isSelected = filteredPersonalityData[currentSelectedSinner.id][index] !== false;
                    console.log(`人格${index} (${persona.name}) 筛选状态: ${isSelected}`);
                    return isSelected;
                });
                
                console.log('过滤后的人格:', filteredPersonalities);
                
                // 如果没有筛选的人格，则显示提示信息
                const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : ['请先选择人格'];
                createPersonaScrollList(personasToShow);
                
                // 重置选中状态 - 但如果只有一个人格，不清除高亮
                if (personasToShow.length !== 1 || typeof personasToShow[0] === 'string') {
                    clearHighlight(personaScroll);
                    selectedPersonaEl.textContent = "未选择";
                } else {
                    // 如果只有一个人格，自动选中
                    selectedPersonaEl.textContent = personasToShow[0].name;
                }
                // 启用或禁用人格选择按钮（由createPersonaScrollList内部处理）
                personaStopBtn.disabled = true;
            } 
            // 如果当前已有选中的罪人，更新二级转盘
            else if (currentSelectedSinner) {
                // 获取筛选后的人格列表
                const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
                    return filteredPersonalityData[currentSelectedSinner.id] && 
                           filteredPersonalityData[currentSelectedSinner.id][index] !== false;
                });
                
                // 如果没有筛选的人格，则显示提示信息
                const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : ['请先选择人格'];
                createPersonaScrollList(personasToShow);
                
                // 重置选中状态 - 但如果只有一个人格，不清除高亮
                if (personasToShow.length !== 1 || typeof personasToShow[0] === 'string') {
                    clearHighlight(personaScroll);
                    selectedPersonaEl.textContent = "未选择";
                } else {
                    // 如果只有一个人格，自动选中
                    selectedPersonaEl.textContent = personasToShow[0].name;
                }
                // 启用或禁用人格选择按钮（由createPersonaScrollList内部处理）
                personaStopBtn.disabled = true;
            } else {
                // 创建空的人格列表
                createPersonaScrollList(['请先选择罪人']);
            }
        }

        // 初始化
        function init() {
            // 创建筛选复选框
            createSinnerFilter();
            
            // 默认全选所有罪人和人格
            filteredSinnerData = [...sinnerData];
            sinnerData.forEach(sinner => {
                filteredPersonalityData[sinner.id] = {};
                sinner.personalities.forEach((_, index) => {
                    filteredPersonalityData[sinner.id][index] = true;
                });
            });
            
            // 保存初始状态
            originalFilteredSinnerData = [...filteredSinnerData];
            originalFilteredPersonalityData = JSON.parse(JSON.stringify(filteredPersonalityData));
            
            // 创建罪人列表
            const sinnerNames = filteredSinnerData.map(sinner => sinner.name);
            createSinnerScrollList(sinnerNames);
            
            // 创建空的人格列表
            createPersonaScrollList(['请先选择罪人']);
            
            // 绑定事件
            sinnerStartBtn.addEventListener('click', startSinnerScroll);
            sinnerStopBtn.addEventListener('click', stopSinnerScroll);
            personaStartBtn.addEventListener('click', startPersonaScroll);
            personaStopBtn.addEventListener('click', stopPersonaScroll);
            
            // 事件委托：监听罪人列表的点击事件
            sinnerScroll.addEventListener('click', (e) => {
                // 查找被点击的滚动项
                const scrollItem = e.target.closest('.scroll-item');
                if (scrollItem) {
                    // 获取原始索引
                    const originalIndex = parseInt(scrollItem.dataset.originalIndex);
                    // 获取对应的罪人
                    const selectedSinner = filteredSinnerData[originalIndex];
                    if (selectedSinner) {
                        // 更新当前选中的罪人
                        currentSelectedSinner = selectedSinner;
                        selectedSinnerEl.textContent = currentSelectedSinner.name;
                        
                        // 高亮选中的项目
                        highlightSelectedItem(sinnerScroll, originalIndex);
                        
                        // 创建对应的人格列表
                        // 确保filteredPersonalityData中存在该罪人的数据
                        if (!filteredPersonalityData[currentSelectedSinner.id]) {
                            filteredPersonalityData[currentSelectedSinner.id] = {};
                            // 默认选择所有人格
                            currentSelectedSinner.personalities.forEach((_, index) => {
                                filteredPersonalityData[currentSelectedSinner.id][index] = true;
                            });
                        }
                        
                        const filteredPersonalities = currentSelectedSinner.personalities.filter((persona, index) => {
                            // 如果没有设置该人格的筛选状态，默认为true
                            const isSelected = filteredPersonalityData[currentSelectedSinner.id][index] !== false;
                            return isSelected;
                        });
                        
                        const personasToShow = filteredPersonalities.length > 0 ? filteredPersonalities : ['请先选择人格'];
                        createPersonaScrollList(personasToShow);
                    }
                }
            });
            
            // 绑定筛选控制按钮事件
            document.getElementById('select-all-btn').addEventListener('click', () => toggleAllCheckboxes(true));
            document.getElementById('deselect-all-btn').addEventListener('click', () => toggleAllCheckboxes(false));
            document.getElementById('invert-selection-btn').addEventListener('click', invertSelection);
            
            // 添加应用筛选按钮
            const applyBtn = document.createElement('button');
            applyBtn.className = 'control-btn';
            applyBtn.textContent = '应用筛选';
            applyBtn.style.marginTop = '20px';
            applyBtn.addEventListener('click', applyFilters);
            document.querySelector('#settings-page .settings-section:last-child').appendChild(applyBtn);
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>

